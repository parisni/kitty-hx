#!/usr/bin/env bash
set -eo pipefail

# Parse arguments
FILEPATH=""
QUERY=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --filepath)
      FILEPATH="$2"
      shift 2
      ;;
    *)
      break
      ;;
  esac
done

# Check if there's stdin (selection text)
if [[ ! -t 0 ]]; then
  RAW_INPUT=$(cat)
  QUERY=$(echo "$RAW_INPUT" | tr -d '\n')  # Just remove newlines
  echo -n "$QUERY"  # Echo the selection immediately without newline
fi

# Build kittyx-live-grep command
LIVE_GREP_CMD="kittyx-live-grep --exit-on-execution --open-in-helix"

# Add query if provided
if [[ -n "$QUERY" ]]; then
  LIVE_GREP_CMD="$LIVE_GREP_CMD --query \"$QUERY\""
fi

# Add search directory if filepath provided
if [[ -n "$FILEPATH" ]]; then
  if [[ -f "$FILEPATH" ]]; then
    WORK_DIR="$(dirname "$FILEPATH")"
  elif [[ -d "$FILEPATH" ]]; then
    WORK_DIR="$FILEPATH"
  else
    echo "Error: File path '$FILEPATH' does not exist."
    exit 1
  fi
  LIVE_GREP_CMD="$LIVE_GREP_CMD --search-dir \"$WORK_DIR\" --quit-yazi"
fi

kitty @ launch \
  --type=tab \
  --title="live-grep" \
  --cwd=current \
  -- bash -c "$LIVE_GREP_CMD" >/dev/null 2>&1

